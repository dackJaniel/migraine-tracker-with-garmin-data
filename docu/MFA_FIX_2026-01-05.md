# MFA-Login Fix - 05.01.2026

## Problem

Beim Garmin Connect Login wurde der Fehler "MFA_REQUIRED" als roter Fehlerbanner angezeigt, anstatt den MFA-Eingabedialog zu öffnen.

![Screenshot zeigt MFA_REQUIRED Fehler](../screenshots/mfa_error.png)

## Analyse

### Root Cause

1. **Auth Service (`src/lib/garmin/auth.ts`):**
   - In `login()` Methode: Wenn SSO Login MFA erfordert, wird `mfaState` korrekt gesetzt
   - ABER: Danach wird `throw new Error('MFA_REQUIRED')` geworfen (Zeile 448-449)
2. **UI (`src/pages/GarminSettings.tsx`):**
   - In `handleLogin()`: Der catch-Block behandelte `MFA_REQUIRED` als generischen Fehler
   - Zeigt den Fehlertext "MFA_REQUIRED" in der roten Error-Box an
   - Der MFA-Dialog wurde nie geöffnet

### Code vor Fix (GarminSettings.tsx, Zeilen 126-134):

```typescript
} catch (error) {
  const message =
    error instanceof Error ? error.message : 'Login fehlgeschlagen';
  setLoginError(message);  // Zeigt "MFA_REQUIRED" als Fehler
  toast.error(message);
} finally {
  setIsLoggingIn(false);
}
```

## Lösung

### Änderung in `src/pages/GarminSettings.tsx`

Der catch-Block in `handleLogin()` wurde erweitert, um den `MFA_REQUIRED` Error speziell zu behandeln:

```typescript
} catch (error) {
  const message =
    error instanceof Error ? error.message : 'Login fehlgeschlagen';

  // MFA_REQUIRED wird als Error geworfen - hier abfangen und MFA-Dialog öffnen
  if (message === 'MFA_REQUIRED') {
    setMfaRequired(true);       // Öffnet MFA-Eingabefeld
    setLoginError(null);        // Kein Fehler anzeigen
    toast.info('Zwei-Faktor-Authentifizierung erforderlich');
    setIsLoggingIn(false);
    return;
  }

  setLoginError(message);
  toast.error(message);
} finally {
  setIsLoggingIn(false);
}
```

## Flow nach Fix

1. User gibt Email + Passwort ein → Klickt "Anmelden"
2. `garminClient.login()` wird aufgerufen
3. Auth Service erkennt MFA-Erfordernis → setzt `mfaState` → wirft `MFA_REQUIRED` Error
4. **NEU:** catch-Block erkennt `MFA_REQUIRED` → setzt `mfaRequired = true`
5. UI zeigt MFA-Eingabefeld (6-stelliger Code)
6. User gibt MFA-Code ein → Klickt "Verifizieren"
7. `garminClient.completeMFA(code)` wird aufgerufen
8. Bei Erfolg: Login abgeschlossen, User verbunden

## Betroffene Dateien

- `src/pages/GarminSettings.tsx` - catch-Block in `handleLogin()` erweitert

## Test-Schritte

1. App auf Android-Gerät öffnen
2. Zu "Garmin" Tab navigieren
3. "Mit Garmin Connect anmelden" klicken
4. Email + Passwort eingeben
5. Bei MFA-aktiviertem Account:
   - **Vorher:** Roter Fehler "MFA_REQUIRED"
   - **Nachher:** Blaues Info-Feld + Eingabefeld für 6-stelligen Code

## Deployment

```bash
npm run build
npx cap sync android
./deploy.sh
```

## Verwandte Dateien

- `src/lib/garmin/auth.ts` - Authentication Service (nicht geändert)
- `src/lib/garmin/client.ts` - Garmin Client Facade (nicht geändert)
- `src/lib/garmin/types.ts` - TypeScript Interfaces (nicht geändert)
