---
phase: 01-api-endpoint-fix
plan: 01
type: execute
---

<objective>
Fix Garmin API endpoint URLs to use `connectapi.garmin.com` subdomain instead of `connect.garmin.com/modern/proxy/` path.

Purpose: The `/modern/proxy/` path requires browser session cookies and doesn't work with OAuth2 Bearer tokens. The `connectapi` subdomain is the proper API endpoint that accepts OAuth2 authentication (as used by garth Python library).

Output: Working Garmin data sync that returns JSON instead of HTML error pages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Reference implementation (garth):**
- `ref/garth/src/garth/http.py` line 186-192: `connectapi()` method builds URLs as `https://connectapi.garmin.com{path}`
- `ref/garth/src/garth/data/sleep.py` line 115-118: path format `/wellness-service/wellness/dailySleepData/{username}?nonSleepBufferMinutes=60&date={day}`

**Current broken implementation:**
@src/lib/garmin/constants.ts
@src/lib/garmin/http-client.ts
@vite.config.ts

**Error logs showing the problem:**
- URLs like `https://connect.garmin.com/modern/proxy/wellness-service/...` return HTML
- OAuth2 Bearer token is present but endpoints don't accept it
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix API endpoint constants</name>
  <files>src/lib/garmin/constants.ts</files>
  <action>
Update the endpoint URL construction to use `connectapi.garmin.com` properly:

1. Update `GARMIN_API_URL` for production to use `https://connectapi.garmin.com`
2. Update `GARMIN_API_URL` for dev to use `/api/connectapi` (new proxy path)
3. Remove `/modern/proxy` from all endpoint paths - they should be direct service paths like `/wellness-service/wellness/dailySleepData/...`
4. Update all `WELLNESS_ENDPOINTS`, `HRV_ENDPOINTS`, `USER_SUMMARY_ENDPOINTS`, `TRAINING_ENDPOINTS` to use simple paths without the proxy prefix

The endpoints should match garth's format:
- Sleep: `/wellness-service/wellness/dailySleepData/{username}?nonSleepBufferMinutes={buffer}&date={date}`
- Stress: `/wellness-service/wellness/dailyStress/{date}`
- HRV: `/hrv-service/hrv/{date}`
- etc.

IMPORTANT: Keep `GARMIN_BASE_URL` (connect.garmin.com) separate for any web UI references, but API data calls must use `GARMIN_API_URL` (connectapi.garmin.com).
  </action>
  <verify>Review constants.ts - all endpoint URLs should NOT contain `/modern/proxy/` and should use `${GARMIN_API_URL}` with clean service paths</verify>
  <done>All endpoint URLs use connectapi subdomain with direct service paths (no /modern/proxy/)</done>
</task>

<task type="auto">
  <name>Task 2: Add connectapi proxy for development</name>
  <files>vite.config.ts</files>
  <action>
Add a new proxy configuration for the connectapi subdomain:

```javascript
'/api/connectapi': {
  target: 'https://connectapi.garmin.com',
  changeOrigin: true,
  rewrite: (path) => path.replace(/^\/api\/connectapi/, ''),
  secure: true,
  configure: (proxy, _options) => {
    proxy.on('proxyReq', (proxyReq, req, _res) => {
      // Forward OAuth2 Bearer token
      if (req.headers.authorization) {
        proxyReq.setHeader('Authorization', req.headers.authorization);
      }
      // Set required headers for Garmin API
      proxyReq.setHeader('User-Agent', 'com.garmin.android.apps.connectmobile');
      proxyReq.setHeader('Accept', 'application/json');
    });
  },
},
```

Keep the existing `/api/garmin` proxy for SSO/login-related endpoints that may still need connect.garmin.com.
  </action>
  <verify>Check vite.config.ts has both `/api/garmin` and `/api/connectapi` proxy entries</verify>
  <done>New /api/connectapi proxy configured targeting connectapi.garmin.com</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] constants.ts endpoint URLs use connectapi subdomain (no /modern/proxy/)
- [ ] vite.config.ts has /api/connectapi proxy entry
- [ ] Review a sample endpoint URL is correct format: `https://connectapi.garmin.com/wellness-service/...`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Endpoint URLs correctly formatted for connectapi subdomain
</success_criteria>

<output>
After completion, create `.planning/phases/01-api-endpoint-fix/01-01-SUMMARY.md`
</output>
