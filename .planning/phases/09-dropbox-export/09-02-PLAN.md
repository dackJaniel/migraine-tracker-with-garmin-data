---
phase: 09-dropbox-export
plan: 02
type: execute
---

<objective>
Create Dropbox settings UI and auto-export functionality.

Purpose: Enable users to connect Dropbox, configure auto-export, and manage their cloud backup settings.
Output: DropboxSettings component in Settings page with auto-export capability.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-dropbox-export/DISCOVERY.md
@.planning/phases/09-dropbox-export/09-01-SUMMARY.md
@src/features/garmin/components/GarminSettings.tsx
@src/lib/dropbox/client.ts
@src/pages/Settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DropboxSettings component</name>
  <files>src/features/dropbox/DropboxSettings.tsx, src/features/dropbox/index.ts</files>
  <action>
1. Create `src/features/dropbox/DropboxSettings.tsx` following GarminSettings pattern:

```typescript
/**
 * DropboxSettings Component
 *
 * Dropbox connection and export management for the Settings page.
 * Following the GarminSettings pattern.
 */

import { useEffect, useState, useCallback } from 'react';
import {
  Cloud,
  LogIn,
  LogOut,
  Loader2,
  CheckCircle2,
  AlertCircle,
  Upload,
  Settings2,
} from 'lucide-react';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import { dropboxClient } from '@/lib/dropbox';
import type { DropboxConnectionStatus } from '@/lib/dropbox';
import { toast } from 'sonner';
import { Capacitor } from '@capacitor/core';
import { formatDistanceToNow } from 'date-fns';
import { de } from 'date-fns/locale';
import { Preferences } from '@capacitor/preferences';

const isWebDev = !Capacitor.isNativePlatform();

const DROPBOX_SETTINGS_KEY = 'dropbox_export_settings';

interface DropboxExportSettings {
  autoExportEnabled: boolean;
  exportPassword: string;
}

function formatLastExport(dateStr: string | null): string {
  if (!dateStr) return 'Noch nie';
  try {
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return 'Unbekannt';
    return formatDistanceToNow(date, { addSuffix: true, locale: de });
  } catch {
    return 'Unbekannt';
  }
}

export function DropboxSettings() {
  // Connection State
  const [isLoading, setIsLoading] = useState(true);
  const [connectionStatus, setConnectionStatus] = useState<DropboxConnectionStatus>({ isConnected: false });

  // Export State
  const [isExporting, setIsExporting] = useState(false);
  const [exportDialogOpen, setExportDialogOpen] = useState(false);
  const [exportPassword, setExportPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  // Settings State
  const [settings, setSettings] = useState<DropboxExportSettings>({
    autoExportEnabled: false,
    exportPassword: ''
  });
  const [settingsDialogOpen, setSettingsDialogOpen] = useState(false);
  const [tempPassword, setTempPassword] = useState('');
  const [tempConfirmPassword, setTempConfirmPassword] = useState('');

  // Load state on mount
  const loadState = useCallback(async () => {
    setIsLoading(true);
    try {
      const status = await dropboxClient.getConnectionStatus();
      setConnectionStatus(status);

      // Load saved settings
      const { value } = await Preferences.get({ key: DROPBOX_SETTINGS_KEY });
      if (value) {
        setSettings(JSON.parse(value));
      }
    } catch (error) {
      console.error('Failed to load Dropbox state:', error);
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    loadState();
  }, [loadState]);

  // Save settings
  const saveSettings = async (newSettings: DropboxExportSettings) => {
    await Preferences.set({
      key: DROPBOX_SETTINGS_KEY,
      value: JSON.stringify(newSettings)
    });
    setSettings(newSettings);
  };

  // Connect Handler
  const handleConnect = async () => {
    try {
      await dropboxClient.connect();
      const status = await dropboxClient.getConnectionStatus();
      setConnectionStatus(status);
      toast.success(`Verbunden mit ${status.accountEmail || 'Dropbox'}`);
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Verbindung fehlgeschlagen';
      toast.error(message);
    }
  };

  // Disconnect Handler
  const handleDisconnect = async () => {
    try {
      await dropboxClient.disconnect();
      setConnectionStatus({ isConnected: false });
      await saveSettings({ ...settings, autoExportEnabled: false });
      toast.success('Dropbox-Verbindung getrennt');
    } catch (error) {
      toast.error('Fehler beim Trennen der Verbindung');
    }
  };

  // Manual Export Handler
  const handleManualExport = async () => {
    if (exportPassword !== confirmPassword) {
      toast.error('Passwörter stimmen nicht überein');
      return;
    }

    if (exportPassword.length < 8) {
      toast.error('Passwort muss mindestens 8 Zeichen haben');
      return;
    }

    setIsExporting(true);
    try {
      const result = await dropboxClient.exportBackup(exportPassword);

      if (result.success) {
        toast.success(`Backup exportiert: ${result.path}`);
        setExportDialogOpen(false);
        setExportPassword('');
        setConfirmPassword('');

        // Refresh status
        const status = await dropboxClient.getConnectionStatus();
        setConnectionStatus({ ...status, lastExport: result.timestamp });
      } else {
        toast.error(result.error || 'Export fehlgeschlagen');
      }
    } catch (error) {
      toast.error('Export fehlgeschlagen');
    } finally {
      setIsExporting(false);
    }
  };

  // Save auto-export settings
  const handleSaveSettings = async () => {
    if (settings.autoExportEnabled || tempPassword) {
      if (tempPassword !== tempConfirmPassword) {
        toast.error('Passwörter stimmen nicht überein');
        return;
      }

      if (tempPassword && tempPassword.length < 8) {
        toast.error('Passwort muss mindestens 8 Zeichen haben');
        return;
      }
    }

    const newSettings: DropboxExportSettings = {
      autoExportEnabled: settings.autoExportEnabled,
      exportPassword: tempPassword || settings.exportPassword
    };

    await saveSettings(newSettings);
    setSettingsDialogOpen(false);
    setTempPassword('');
    setTempConfirmPassword('');
    toast.success('Einstellungen gespeichert');
  };

  if (isLoading) {
    return (
      <Card>
        <CardContent className="p-6 flex justify-center">
          <Loader2 className="h-6 w-6 animate-spin" />
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      {/* Connection Status */}
      <Card className={connectionStatus.isConnected ? 'bg-blue-50 border-blue-200' : ''}>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            {connectionStatus.isConnected ? (
              <CheckCircle2 className="h-5 w-5 text-blue-600" />
            ) : (
              <AlertCircle className="h-5 w-5 text-amber-600" />
            )}
            {connectionStatus.isConnected ? 'Dropbox verbunden' : 'Nicht verbunden'}
          </CardTitle>
          <CardDescription>
            {connectionStatus.isConnected
              ? `Angemeldet als ${connectionStatus.accountEmail || 'User'}`
              : 'Verbinde dich mit Dropbox für verschlüsselte Cloud-Backups'}
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Web Dev Warning */}
          {isWebDev && !connectionStatus.isConnected && (
            <div className="text-sm text-amber-700 bg-amber-50 p-3 rounded-lg border border-amber-200">
              <strong>Entwicklungsmodus:</strong> Die Dropbox-Anmeldung funktioniert nur in der Android-App.
            </div>
          )}

          {!connectionStatus.isConnected ? (
            <Button onClick={handleConnect} className="w-full sm:w-auto">
              <LogIn className="h-4 w-4 mr-2" />
              Mit Dropbox verbinden
            </Button>
          ) : (
            <div className="flex flex-col sm:flex-row gap-2">
              {/* Manual Export */}
              <Dialog open={exportDialogOpen} onOpenChange={setExportDialogOpen}>
                <DialogTrigger asChild>
                  <Button className="w-full sm:w-auto">
                    <Upload className="h-4 w-4 mr-2" />
                    Jetzt exportieren
                  </Button>
                </DialogTrigger>
                <DialogContent>
                  <DialogHeader>
                    <DialogTitle>Backup zu Dropbox exportieren</DialogTitle>
                    <DialogDescription>
                      Deine Daten werden vor dem Upload verschlüsselt. Merke dir das Passwort!
                    </DialogDescription>
                  </DialogHeader>
                  <div className="space-y-4 py-4">
                    <div className="space-y-2">
                      <Label htmlFor="export-password">Verschlüsselungspasswort</Label>
                      <Input
                        id="export-password"
                        type="password"
                        placeholder="Mindestens 8 Zeichen"
                        value={exportPassword}
                        onChange={e => setExportPassword(e.target.value)}
                        disabled={isExporting}
                      />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="export-confirm">Passwort bestätigen</Label>
                      <Input
                        id="export-confirm"
                        type="password"
                        placeholder="Passwort wiederholen"
                        value={confirmPassword}
                        onChange={e => setConfirmPassword(e.target.value)}
                        disabled={isExporting}
                      />
                    </div>
                  </div>
                  <DialogFooter>
                    <Button
                      variant="outline"
                      onClick={() => setExportDialogOpen(false)}
                    >
                      Abbrechen
                    </Button>
                    <Button onClick={handleManualExport} disabled={isExporting}>
                      {isExporting && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                      Exportieren
                    </Button>
                  </DialogFooter>
                </DialogContent>
              </Dialog>

              {/* Auto-Export Settings */}
              <Dialog open={settingsDialogOpen} onOpenChange={setSettingsDialogOpen}>
                <DialogTrigger asChild>
                  <Button variant="outline" className="w-full sm:w-auto">
                    <Settings2 className="h-4 w-4 mr-2" />
                    Auto-Export
                  </Button>
                </DialogTrigger>
                <DialogContent>
                  <DialogHeader>
                    <DialogTitle>Auto-Export Einstellungen</DialogTitle>
                    <DialogDescription>
                      Automatische Backups nach jedem Sync
                    </DialogDescription>
                  </DialogHeader>
                  <div className="space-y-4 py-4">
                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label>Auto-Export aktivieren</Label>
                        <p className="text-sm text-slate-500">
                          Nach jedem Garmin-Sync automatisch exportieren
                        </p>
                      </div>
                      <Switch
                        checked={settings.autoExportEnabled}
                        onCheckedChange={checked =>
                          setSettings({ ...settings, autoExportEnabled: checked })
                        }
                      />
                    </div>
                    {settings.autoExportEnabled && (
                      <>
                        <div className="space-y-2">
                          <Label htmlFor="auto-password">Verschlüsselungspasswort</Label>
                          <Input
                            id="auto-password"
                            type="password"
                            placeholder={settings.exportPassword ? '••••••••' : 'Neues Passwort'}
                            value={tempPassword}
                            onChange={e => setTempPassword(e.target.value)}
                          />
                          <p className="text-xs text-slate-500">
                            {settings.exportPassword
                              ? 'Leer lassen um bestehendes Passwort zu behalten'
                              : 'Wird für alle automatischen Exports verwendet'}
                          </p>
                        </div>
                        {tempPassword && (
                          <div className="space-y-2">
                            <Label htmlFor="auto-confirm">Passwort bestätigen</Label>
                            <Input
                              id="auto-confirm"
                              type="password"
                              placeholder="Passwort wiederholen"
                              value={tempConfirmPassword}
                              onChange={e => setTempConfirmPassword(e.target.value)}
                            />
                          </div>
                        )}
                      </>
                    )}
                  </div>
                  <DialogFooter>
                    <Button
                      variant="outline"
                      onClick={() => {
                        setSettingsDialogOpen(false);
                        setTempPassword('');
                        setTempConfirmPassword('');
                      }}
                    >
                      Abbrechen
                    </Button>
                    <Button onClick={handleSaveSettings}>Speichern</Button>
                  </DialogFooter>
                </DialogContent>
              </Dialog>

              {/* Disconnect */}
              <AlertDialog>
                <AlertDialogTrigger asChild>
                  <Button variant="outline" className="w-full sm:w-auto">
                    <LogOut className="h-4 w-4 mr-2" />
                    Trennen
                  </Button>
                </AlertDialogTrigger>
                <AlertDialogContent>
                  <AlertDialogHeader>
                    <AlertDialogTitle>Dropbox-Verbindung trennen?</AlertDialogTitle>
                    <AlertDialogDescription>
                      Du wirst von Dropbox abgemeldet. Bereits exportierte Backups bleiben in Dropbox erhalten.
                    </AlertDialogDescription>
                  </AlertDialogHeader>
                  <AlertDialogFooter>
                    <AlertDialogCancel>Abbrechen</AlertDialogCancel>
                    <AlertDialogAction onClick={handleDisconnect}>
                      Trennen
                    </AlertDialogAction>
                  </AlertDialogFooter>
                </AlertDialogContent>
              </AlertDialog>
            </div>
          )}

          {/* Export Status */}
          {connectionStatus.isConnected && (
            <div className="bg-slate-50 rounded-lg p-4">
              <div className="text-sm text-slate-600">Letzter Export</div>
              <div className="text-lg font-semibold">
                {formatLastExport(connectionStatus.lastExport || null)}
              </div>
              {settings.autoExportEnabled && (
                <div className="text-xs text-green-600 mt-1">
                  Auto-Export aktiv
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Info Card */}
      <Card className="bg-blue-50 border-blue-200">
        <CardContent className="pt-6">
          <div className="flex gap-4">
            <Cloud className="h-5 w-5 text-blue-600 shrink-0 mt-0.5" />
            <div className="space-y-2">
              <h4 className="font-medium text-blue-900">Hinweise zum Dropbox-Backup</h4>
              <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
                <li>Alle Backups werden vor dem Upload verschlüsselt (AES-256)</li>
                <li>Ohne Passwort können Backups nicht wiederhergestellt werden</li>
                <li>Backups werden im Ordner /MigraineTracker gespeichert</li>
              </ul>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

2. Create `src/features/dropbox/index.ts`:
```typescript
export { DropboxSettings } from './DropboxSettings';
```
  </action>
  <verify>npm run build passes, component compiles without errors</verify>
  <done>DropboxSettings component created following GarminSettings pattern</done>
</task>

<task type="auto">
  <name>Task 2: Integrate DropboxSettings into Settings page</name>
  <files>src/pages/Settings.tsx</files>
  <action>
1. Add Dropbox tab to Settings page:

- Import DropboxSettings: `import { DropboxSettings } from '@/features/dropbox';`

- Add new TabsTrigger after "sync":
  `<TabsTrigger value="dropbox">Dropbox</TabsTrigger>`

- Add new TabsContent after sync tab:
```tsx
{/* Dropbox Tab */}
<TabsContent value="dropbox" className="space-y-4">
  <DropboxSettings />
</TabsContent>
```

Keep existing tab order: security, garmin, weather, sync, dropbox, data, debug
  </action>
  <verify>npm run build passes, Dropbox tab visible in Settings</verify>
  <done>DropboxSettings integrated into Settings page with dedicated tab</done>
</task>

<task type="auto">
  <name>Task 3: Add auto-export hook to sync service</name>
  <files>src/lib/auto-sync/service.ts</files>
  <action>
1. Update auto-sync service to trigger Dropbox export after successful sync:

At the top, add imports:
```typescript
import { Preferences } from '@capacitor/preferences';
import { dropboxClient } from '@/lib/dropbox';
```

Add constant:
```typescript
const DROPBOX_SETTINGS_KEY = 'dropbox_export_settings';
```

Add helper function to get export settings:
```typescript
async function getDropboxExportSettings(): Promise<{ autoExportEnabled: boolean; exportPassword: string } | null> {
  try {
    const { value } = await Preferences.get({ key: DROPBOX_SETTINGS_KEY });
    return value ? JSON.parse(value) : null;
  } catch {
    return null;
  }
}
```

At the end of the performAutoSync function, after successful Garmin sync, add:
```typescript
// Auto-export to Dropbox if enabled
try {
  const dropboxSettings = await getDropboxExportSettings();
  if (dropboxSettings?.autoExportEnabled && dropboxSettings?.exportPassword) {
    const isConnected = await dropboxClient.isConnected();
    if (isConnected) {
      console.log('[AutoSync] Triggering Dropbox auto-export...');
      const result = await dropboxClient.exportBackup(dropboxSettings.exportPassword);
      if (result.success) {
        console.log('[AutoSync] Dropbox export successful:', result.path);
      } else {
        console.warn('[AutoSync] Dropbox export failed:', result.error);
      }
    }
  }
} catch (error) {
  console.warn('[AutoSync] Dropbox auto-export error:', error);
  // Don't fail the sync if Dropbox export fails
}
```

This should be placed right before the return statement in performAutoSync, after both Garmin and weather syncs complete.
  </action>
  <verify>npm run build passes, auto-export logic integrated</verify>
  <done>Auto-export triggers after successful sync when enabled</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] DropboxSettings component renders correctly
- [ ] Settings page shows Dropbox tab
- [ ] Auto-export integration doesn't break existing sync
</verification>

<success_criteria>

- DropboxSettings component created and working
- Settings page includes Dropbox tab
- Manual export via UI works
- Auto-export triggers after Garmin sync (when enabled)
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-dropbox-export/09-02-SUMMARY.md`
</output>
