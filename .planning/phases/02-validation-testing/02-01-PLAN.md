---
phase: 02-validation-testing
plan: 01
type: execute
---

<objective>
Fix Sleep Score, SpO2, and HRV data parsing to correctly extract values from Garmin API responses.

Purpose: The sync works but these metrics return null because the TypeScript code looks for wrong field paths. The garth Python reference shows the correct response structure.

Output: Sleep Score, SpO2, and HRV values properly extracted and stored in IndexedDB.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-api-endpoint-fix/01-01-SUMMARY.md

**Reference implementation (garth):**
- `ref/garth/src/garth/data/sleep.py` lines 29-38: sleepScores structure
- `ref/garth/src/garth/data/sleep.py` lines 68-71: SpO2 fields in dailySleepDTO
- `ref/garth/src/garth/data/hrv.py` lines 23-30: HRVSummary with lastNightAvg

**Current broken parsing:**
@src/lib/garmin/types.ts
@src/lib/garmin/endpoints/sleep.ts
@src/lib/garmin/endpoints/stress.ts (contains HRV)
@src/lib/garmin/endpoints/misc.ts (contains SpO2)

**Key findings from garth cassettes:**
- Sleep response has `dailySleepDTO.sleepScores.overall.value` (not `sleepScore`)
- Sleep response has `dailySleepDTO.averageSpO2Value`, `lowestSpO2Value`, `highestSpO2Value`
- HRV response has `hrvSummary.lastNightAvg` (not top-level `hrvValue`)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Sleep Score parsing</name>
  <files>src/lib/garmin/types.ts, src/lib/garmin/endpoints/sleep.ts</files>
  <action>
1. Update SleepDataResponse type in types.ts to include the correct nested structure:
   ```typescript
   export interface SleepDataResponse {
     dailySleepDTO?: {
       sleepTimeSeconds: number;
       deepSleepSeconds: number;
       lightSleepSeconds: number;
       remSleepSeconds: number;
       awakeSleepSeconds: number;
       // Correct structure from garth:
       sleepScores?: {
         overall?: {
           value?: number;
           qualifierKey?: string;
         };
       };
       // SpO2 data is included in sleep response
       averageSpO2Value?: number;
       lowestSpO2Value?: number;
       highestSpO2Value?: number;
     };
   }
   ```

2. Update parseSleepResponse in sleep.ts to extract sleepScore correctly:
   ```typescript
   sleepScore: sleep.sleepScores?.overall?.value,
   ```

3. Also extract SpO2 from sleep data and add to SleepData interface:
   ```typescript
   export interface SleepData {
     // ... existing fields
     averageSpO2?: number;
   }
   ```
  </action>
  <verify>Review types.ts and sleep.ts - sleepScore uses nested path sleepScores.overall.value, SpO2 fields added</verify>
  <done>SleepData includes sleepScore from correct path and averageSpO2 from sleep response</done>
</task>

<task type="auto">
  <name>Task 2: Fix HRV parsing</name>
  <files>src/lib/garmin/types.ts, src/lib/garmin/endpoints/stress.ts</files>
  <action>
1. Update HRVDataResponse type in types.ts to match garth's actual structure:
   ```typescript
   export interface HRVDataResponse {
     hrvSummary?: {
       lastNightAvg?: number;
       weeklyAvg?: number;
       status?: string;
       feedbackPhrase?: string;
       calendarDate?: string;
     };
     hrvReadings?: Array<{
       hrvValue: number;
       readingTimeGmt: string;
       readingTimeLocal: string;
     }>;
   }
   ```

2. Update getHRVData in stress.ts to extract from hrvSummary:
   ```typescript
   return {
     hrvValue: hrvData.hrvSummary?.lastNightAvg,
     lastNightAverage: hrvData.hrvSummary?.lastNightAvg,
     weeklyAverage: hrvData.hrvSummary?.weeklyAvg,
     status: hrvData.hrvSummary?.status,
   };
   ```
  </action>
  <verify>Review types.ts and stress.ts - HRV uses hrvSummary.lastNightAvg path</verify>
  <done>HRVData correctly extracts lastNightAvg from hrvSummary nested object</done>
</task>

<task type="auto">
  <name>Task 3: Update sync-service to use SpO2 from sleep data</name>
  <files>src/lib/garmin/sync-service.ts</files>
  <action>
Since SpO2 is included in the sleep response (not a separate endpoint), update sync-service.ts to:

1. Extract spo2 from sleepData instead of calling getSpo2Data:
   ```typescript
   // Remove or deprecate the separate getSpo2Data call
   // Instead, get SpO2 from sleepData.averageSpO2
   spo2: sleepData?.averageSpO2,
   ```

2. The separate getSpo2Data endpoint can remain as fallback, but prioritize sleep data.

Note: The USER_SUMMARY_ENDPOINTS.SPO2 endpoint path `/wellness-service/wellness/daily/spo2/{date}` may not exist - garth doesn't have a separate SpO2 endpoint, it's all in sleep data.
  </action>
  <verify>Review sync-service.ts - spo2 populated from sleepData.averageSpO2</verify>
  <done>SpO2 extracted from sleep response, not separate API call</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] SleepDataResponse type has sleepScores.overall.value structure
- [ ] SleepDataResponse type has averageSpO2Value field
- [ ] HRVDataResponse type has hrvSummary.lastNightAvg structure
- [ ] sync-service extracts spo2 from sleepData
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Types match garth reference implementation structure
</success_criteria>

<output>
After completion, create `.planning/phases/02-validation-testing/02-01-SUMMARY.md`
</output>
