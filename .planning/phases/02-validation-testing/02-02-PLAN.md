---
phase: 02-validation-testing
plan: 02
type: execute
---

<objective>
Fix Hydration endpoint and verify all metrics sync correctly on Android.

Purpose: Hydration uses wrong endpoint path. After fixing, all 4 problematic metrics (Sleep Score, HRV, Hydration, SpO2) should sync correctly.

Output: Working hydration sync and verified Android deployment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-validation-testing/02-01-SUMMARY.md

**Reference implementation (garth):**
- `ref/garth/src/garth/stats/hydration.py` line 11: BASE_PATH = "/usersummary-service/stats/hydration"
- `ref/garth/src/garth/stats/hydration.py` line 31: path pattern `{BASE_PATH}/daily/{start}/{end}`

**Current broken endpoint:**
@src/lib/garmin/constants.ts - HYDRATION uses `/usersummary-service/hydration/allData/{date}` (wrong)

**Correct endpoint format:**
`/usersummary-service/stats/hydration/daily/{date}/{date}` (same date for start/end to get single day)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Hydration endpoint</name>
  <files>src/lib/garmin/constants.ts</files>
  <action>
Update HYDRATION endpoint in USER_SUMMARY_ENDPOINTS to use correct path from garth:

```typescript
HYDRATION: (date: string) => `${GARMIN_API_URL}/usersummary-service/stats/hydration/daily/${date}/${date}`,
```

The endpoint takes start/end dates - use same date twice for single day data.
  </action>
  <verify>Review constants.ts - HYDRATION endpoint uses /usersummary-service/stats/hydration/daily/{date}/{date}</verify>
  <done>HYDRATION endpoint matches garth reference implementation path</done>
</task>

<task type="auto">
  <name>Task 2: Update Hydration response parsing</name>
  <files>src/lib/garmin/types.ts, src/lib/garmin/endpoints/activity.ts</files>
  <action>
1. Check garth's DailyHydration response structure and update HydrationDataResponse if needed.
   From garth: response has `value_in_ml` and `goal_in_ml` fields (snake_case in Python, likely camelCase in JSON).

2. The response from `/stats/hydration/daily/{start}/{end}` returns an array of daily entries.
   Update parsing in activity.ts getHydrationData to handle array response:
   ```typescript
   // Response is likely an array, take first entry
   const entries = Array.isArray(data) ? data : [data];
   const todayEntry = entries[0];
   return {
     valueInML: todayEntry?.valueInML,
     goalInML: todayEntry?.goalInML,
   };
   ```
  </action>
  <verify>Review types.ts and activity.ts - Hydration parsing handles array response correctly</verify>
  <done>Hydration correctly parses daily stats endpoint response</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed Sleep Score, HRV, SpO2, and Hydration parsing/endpoints</what-built>
  <how-to-verify>
1. Run: `npm run build && npx cap sync android`
2. Open Android Studio and deploy to device
3. Login to Garmin account
4. Trigger a sync
5. Check Settings > Debug section to verify:
   - Sleep Score: shows numeric value (not 0 or null)
   - HRV: shows numeric value
   - Hydration: shows value in ml
   - SpO2: shows percentage value
6. If any metric still shows 0/null, check app logs for specific errors
  </how-to-verify>
  <resume-signal>Type "approved" if all metrics sync, or describe which ones still fail</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] HYDRATION endpoint uses correct path
- [ ] User verified on Android that metrics sync correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- User confirms Sleep Score, HRV, Hydration, SpO2 all sync on Android
- Phase 2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-validation-testing/02-02-SUMMARY.md`
</output>
