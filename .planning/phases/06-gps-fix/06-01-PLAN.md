---
phase: 06-gps-fix
plan: 01
type: execute
---

<objective>
Fix Android GPS location detection by using Capacitor Geolocation plugin instead of browser API.

Purpose: The current browser `navigator.geolocation` API fails on Android with "Standort konnte nicht ermittelt werden" because no location permissions are declared and the browser API doesn't properly integrate with Android's location services.

Output: Working GPS location detection on Android device.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@src/lib/weather/location-service.ts
@android/app/src/main/AndroidManifest.xml
@package.json

**Root cause identified:**
- Current: Uses `navigator.geolocation.getCurrentPosition()` (browser API)
- Problem: Android requires explicit location permissions in AndroidManifest.xml
- Problem: Browser API doesn't trigger Android permission dialogs properly in WebView
- Solution: Use `@capacitor/geolocation` plugin which handles Android permissions natively

**Capacitor Geolocation API (from docs):**
```typescript
import { Geolocation } from '@capacitor/geolocation';

// Check/request permissions
const status = await Geolocation.requestPermissions();
// status.location: 'granted' | 'denied' | 'prompt'

// Get position
const position = await Geolocation.getCurrentPosition({
  enableHighAccuracy: false,
  timeout: 10000,
  maximumAge: 300000
});
// position.coords.latitude, position.coords.longitude
```

**Required Android permissions:**
- `android.permission.ACCESS_COARSE_LOCATION`
- `android.permission.ACCESS_FINE_LOCATION`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Capacitor Geolocation plugin and add Android permissions</name>
  <files>package.json, android/app/src/main/AndroidManifest.xml</files>
  <action>
1. Install the plugin:
   ```bash
   npm install @capacitor/geolocation
   npx cap sync android
   ```

2. Add location permissions to AndroidManifest.xml (before </manifest>):
   ```xml
   <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
   <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
   <uses-feature android:name="android.hardware.location.gps" android:required="false" />
   ```
  </action>
  <verify>
- `npm ls @capacitor/geolocation` shows the package installed
- AndroidManifest.xml contains both ACCESS_COARSE_LOCATION and ACCESS_FINE_LOCATION permissions
  </verify>
  <done>Plugin installed, permissions declared in manifest</done>
</task>

<task type="auto">
  <name>Task 2: Update location-service.ts to use Capacitor Geolocation</name>
  <files>src/lib/weather/location-service.ts</files>
  <action>
Replace the `getCurrentLocation()` function to use Capacitor Geolocation:

1. Add imports at top:
   ```typescript
   import { Geolocation } from '@capacitor/geolocation';
   import { Capacitor } from '@capacitor/core';
   ```

2. Rewrite `getCurrentLocation()`:
   - On native platform (Capacitor): Use `Geolocation.requestPermissions()` then `Geolocation.getCurrentPosition()`
   - On web: Fall back to browser `navigator.geolocation` API (for dev mode)
   - Use `Capacitor.isNativePlatform()` to detect which to use
   - Keep same options: enableHighAccuracy: false, timeout: 10000, maximumAge: 300000

3. Handle permission errors specifically:
   - If permissions denied, log clear message: "Location permission denied"
   - If location services disabled, log: "Location services disabled"

4. Keep the same return type (Location | null) and same behavior for reverse geocoding
  </action>
  <verify>
- `npm run build` succeeds without TypeScript errors
- location-service.ts imports Geolocation from @capacitor/geolocation
- getCurrentLocation() calls Geolocation.requestPermissions() on native
  </verify>
  <done>location-service.ts uses Capacitor Geolocation on native, falls back to browser API on web</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GPS location detection using Capacitor Geolocation plugin with Android permissions</what-built>
  <how-to-verify>
    1. Build and deploy to Android:
       ```bash
       npm run build && npx cap sync android
       ```
    2. Open in Android Studio and run on device/emulator
    3. Go to Settings > Wetter > click "GPS" button
    4. Android should show location permission dialog
    5. Grant permission
    6. Location should be detected and shown (e.g., "Berlin, Deutschland")
  </how-to-verify>
  <resume-signal>Type "approved" if GPS works, or describe the error message if it fails</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `@capacitor/geolocation` in package.json dependencies
- [ ] AndroidManifest.xml has ACCESS_COARSE_LOCATION and ACCESS_FINE_LOCATION
- [ ] location-service.ts uses Capacitor Geolocation on native platform
- [ ] GPS button triggers Android permission dialog
- [ ] Location is detected after permission granted
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- GPS location detection works on Android device
- Permission flow is handled correctly (dialog shown, can be granted)
- Web development mode still works (falls back to browser API)
</success_criteria>

<output>
After completion, create `.planning/phases/06-gps-fix/06-01-SUMMARY.md`
</output>
