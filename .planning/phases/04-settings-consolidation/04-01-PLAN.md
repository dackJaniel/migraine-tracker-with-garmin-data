---
phase: 04-settings-consolidation
plan: 01
type: execute
---

<objective>
Extract Garmin login/connection/sync controls into a GarminSettings component embedded in Settings page.

Purpose: Consolidate all integrations (Weather, Garmin) under Settings following the same pattern.
Output: New GarminSettings component in Settings tab, showing email instead of displayName.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior work:**
@.planning/phases/01-api-endpoint-fix/01-01-SUMMARY.md
@.planning/phases/02-validation-testing/02-01-SUMMARY.md

**Key source files:**
@src/pages/Settings.tsx
@src/pages/GarminPage.tsx
@src/features/weather/WeatherSettings.tsx
@src/features/garmin/components/SyncControls.tsx
@src/lib/garmin/client.ts

**Pattern to follow:**
WeatherSettings.tsx is embedded directly in Settings.tsx Wetter tab. GarminSettings should follow the same pattern - a self-contained component that handles all Garmin connection/login/sync state internally.

**Requirements from ROADMAP:**
- Settings/Sync/Login alle unter Einstellungen verschieben
- Garmin Connect: E-Mail statt Nummer anzeigen
- Garmin-Verbindung nur noch unter Einstellungen
- Manueller Re-Sync Button in Einstellungen
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GarminSettings component</name>
  <files>src/features/garmin/components/GarminSettings.tsx, src/features/garmin/components/index.ts</files>
  <action>
Create a new GarminSettings component following the WeatherSettings pattern:

1. Extract login dialog, MFA handling, connection status, and sync controls from GarminPage.tsx
2. Make it self-contained with its own state management (no props needed)
3. Show profile.email instead of profile.displayName for connected user
4. Include:
   - Connection status card (green when connected, amber when not)
   - Login dialog with email/password and MFA support
   - Sync controls: Quick Sync (7 days), Full Sync, manual resync
   - Disconnect button with confirmation
5. Export from components/index.ts

Key differences from GarminPage:
- No date navigation
- No GarminDataDisplay
- Focus on connection management only
- Uses profile.email for display

Follow WeatherSettings patterns:
- Self-contained state with useEffect for initial load
- loadSessionState() on mount
- Clean loading state handling
- toast notifications for feedback
  </action>
  <verify>
- File exists: src/features/garmin/components/GarminSettings.tsx
- Component exported from index.ts
- No TypeScript errors: npx tsc --noEmit
  </verify>
  <done>
GarminSettings component created, exports profile.email for connected users, handles login/MFA/sync/disconnect
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate GarminSettings into Settings page</name>
  <files>src/pages/Settings.tsx</files>
  <action>
Replace the Garmin tab content in Settings.tsx:

1. Import GarminSettings from '@/features/garmin/components'
2. Replace the current Garmin tab content (the Card with "Garmin Einstellungen Ã¶ffnen" button) with:
   `<GarminSettings />`
3. Remove the navigate('/garmin') import if no longer needed
4. Keep the Watch icon in TabsTrigger

The Garmin tab should now directly render the GarminSettings component, just like Weather tab renders WeatherSettings.

Remove: Button to navigate to /garmin, CardContent with the link
Add: Direct GarminSettings component render
  </action>
  <verify>
- Build passes: npm run build
- Settings page loads without errors
- Garmin tab shows connection controls directly (not a link)
  </verify>
  <done>
Settings page Garmin tab renders GarminSettings component directly
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] Settings page Garmin tab shows login/sync controls (not just a link)
- [ ] Connected state shows email address
</verification>

<success_criteria>

- GarminSettings component exists and is self-contained
- Settings page Garmin tab embeds GarminSettings directly
- Email displayed instead of displayName for connected users
- No build or TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-settings-consolidation/04-01-SUMMARY.md`
</output>
