---
phase: 08-analytics-enhancement
plan: 01
type: execute
---

<objective>
Improve correlation analytics: add 0-value filtering, new correlations, prominent display in overview, and clearer accuracy indicators.

Purpose: Make correlations more reliable (no false patterns from 0-values) and more visible (front and center in overview).
Output: Enhanced correlation logic and UI with significant insights prominently displayed.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key source files:**
@src/features/analytics/correlation-service.ts
@src/features/analytics/CorrelationInsights.tsx
@src/features/analytics/EpisodeCharts.tsx
@src/pages/Analytics.tsx

**Phase scope from roadmap:**
- Korrelationen in Übersicht nach vorne (move correlations to front)
- Mehr Korrelationen abdecken (cover more correlations)
- Keine Korrelationen bei 0-Werten bilden (skip 0-value correlations)
- Genauere Darstellung der Korrelationen (more accurate display)

**Prior decisions:**
- Phase 7: Auto-sync works, Garmin data is reliably available
- Correlations already cover 10 types (sleep, stress, HRV, bodyBattery, triggers, nightOnset, pressure, temp, humidity, weather)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 0-value filtering and new correlations</name>
  <files>src/features/analytics/correlation-service.ts</files>
  <action>
  1. Add 0-value filtering to all correlation functions:
     - In analyzeSleepCorrelation: Skip days where sleepStages values are all 0
     - In analyzeStressCorrelation: Skip if stressLevel.average is 0 or undefined
     - In analyzeHRVCorrelation: Skip if hrv is 0 or undefined
     - In analyzeBodyBatteryCorrelation: Skip if bodyBattery.current is 0 or undefined
     - In weather correlations: Skip if pressure/temp/humidity values are 0 or missing

  2. Add new correlation types:
     - analyzeStepsCorrelation(): Check if low step count days (<3000 steps) correlate with migraines
     - analyzeRestingHRCorrelation(): Check if elevated resting HR (>personal average) correlates with migraines
     - analyzeHydrationCorrelation(): Check if low hydration correlates with migraines (if hydration data exists)

  3. Add new correlations to analyzeAllCorrelations() array

  4. Add new types to CorrelationResult['type']: 'steps' | 'restingHR' | 'hydration'

  Important: Use same pattern as existing correlations - check for minimum 5 episodes, calculate percentage, determine significance.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>
  - 0-value guards added to all existing correlation functions
  - 3 new correlation types added (steps, restingHR, hydration)
  - CorrelationResult type updated with new types
  - analyzeAllCorrelations includes new correlations
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TopInsights component to Overview tab</name>
  <files>src/features/analytics/TopInsights.tsx, src/features/analytics/index.ts, src/features/analytics/EpisodeCharts.tsx</files>
  <action>
  1. Create TopInsights.tsx component:
     - Show max 3 most significant correlations (highest percentage + isSignificant=true)
     - Compact card design with icon, title, percentage, and brief description
     - Link to full correlations tab: "Alle Korrelationen anzeigen" button
     - If no significant correlations: Show encouraging message "Noch keine signifikanten Muster erkannt"

  2. Export from index.ts

  3. Import and add TopInsights to EpisodeCharts.tsx:
     - Place at the TOP of the grid, before "Episoden pro Monat" chart
     - Use lg:col-span-2 to span full width

  UI pattern: Follow existing Card/CardHeader/CardContent pattern from other components.
  </action>
  <verify>npm run build succeeds without errors</verify>
  <done>
  - TopInsights.tsx component created and exported
  - Shows top 3 significant correlations with link to full view
  - Integrated into EpisodeCharts at top position
  - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Improve correlation display accuracy</name>
  <files>src/features/analytics/CorrelationInsights.tsx</files>
  <action>
  1. Add confidence level indicator based on sample size:
     - sampleSize < 10: "Wenige Daten" (gray badge)
     - sampleSize 10-30: "Moderat" (yellow badge)
     - sampleSize > 30: "Belastbar" (green badge)

  2. Improve percentage display:
     - Show comparison to baseline where available (e.g., "50% vs. 20% Baseline")
     - Add trend indicator if historical data exists

  3. Update description wording for clarity:
     - Avoid implying causation
     - Use "X% deiner Migräne-Tage hatten..." instead of ambiguous phrasing

  4. Add icons for new correlation types (steps, restingHR, hydration) in getIcon()

  5. Handle edge case: If all correlations filtered out by 0-value guards, show appropriate message
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>
  - Confidence level badges based on sample size
  - Clearer percentage display with baseline comparison where available
  - Icons added for new correlation types
  - Edge case handled for empty correlation list
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] TopInsights appears at top of Analytics Overview tab
- [ ] New correlations (steps, restingHR, hydration) appear when data exists
- [ ] 0-value filtering prevents false correlations
- [ ] Confidence badges show on correlation cards
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Correlations visible in overview (prominent position)
- New correlation types functional
- 0-values properly filtered
- Display accuracy improved with confidence indicators
</success_criteria>

<output>
After completion, create `.planning/phases/08-analytics-enhancement/08-01-SUMMARY.md`
</output>
