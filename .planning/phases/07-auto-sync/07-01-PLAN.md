---
phase: 07-auto-sync
plan: 01
type: execute
---

<objective>
Implement automatic sync on app open with Settings UI for configuration.

Purpose: Automatically sync Garmin and Weather data when user opens the app (if >24h since last sync).
Output: Auto-sync service, Settings UI with toggle and status display.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-auto-sync/DISCOVERY.md

# Existing sync services to integrate with
@src/lib/garmin/sync-service.ts
@src/lib/weather/sync-service.ts

# Settings patterns
@src/pages/Settings.tsx
@src/features/weather/WeatherSettings.tsx

# App entry point
@src/App.tsx

**Established patterns:**
- Self-contained settings components (WeatherSettings, GarminSettings)
- Existing isSyncNeeded() and shouldSyncWeather() functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auto-sync service</name>
  <files>src/lib/auto-sync/service.ts, src/lib/auto-sync/index.ts</files>
  <action>
Create src/lib/auto-sync/service.ts:

```typescript
/**
 * Auto-Sync Service
 * Syncs Garmin and Weather data on app open if needed (>24h since last sync)
 */
import { getSetting, setSetting, addLog } from '@/lib/db';
import { syncAllMissingData as syncGarmin, isSyncNeeded as isGarminSyncNeeded } from '@/lib/garmin/sync-service';
import { garminAuth } from '@/lib/garmin/auth';
import { autoSyncWeather, shouldSyncWeather } from '@/lib/weather/sync-service';

const AUTO_SYNC_ENABLED_KEY = 'auto_sync_enabled';
const LAST_AUTO_SYNC_KEY = 'last_auto_sync';

export interface AutoSyncStatus {
  enabled: boolean;
  lastSync: string | null;
  isSyncing: boolean;
}

// In-memory syncing state (not persisted)
let isSyncing = false;

/**
 * Check if auto-sync is enabled
 */
export async function isAutoSyncEnabled(): Promise<boolean> {
  return getSetting<boolean>(AUTO_SYNC_ENABLED_KEY, true); // Default: enabled
}

/**
 * Enable or disable auto-sync
 */
export async function setAutoSyncEnabled(enabled: boolean): Promise<void> {
  await setSetting(AUTO_SYNC_ENABLED_KEY, enabled);
  await addLog('info', `Auto-sync ${enabled ? 'aktiviert' : 'deaktiviert'}`);
}

/**
 * Get last auto-sync timestamp
 */
export async function getLastAutoSync(): Promise<string | null> {
  return getSetting<string | null>(LAST_AUTO_SYNC_KEY, null);
}

/**
 * Get current auto-sync status
 */
export async function getAutoSyncStatus(): Promise<AutoSyncStatus> {
  const [enabled, lastSync] = await Promise.all([
    isAutoSyncEnabled(),
    getLastAutoSync(),
  ]);

  return {
    enabled,
    lastSync,
    isSyncing,
  };
}

/**
 * Perform auto-sync if needed
 * Called on app open
 */
export async function performAutoSyncIfNeeded(): Promise<{
  synced: boolean;
  garmin: boolean;
  weather: boolean;
}> {
  const result = { synced: false, garmin: false, weather: false };

  // Check if enabled
  const enabled = await isAutoSyncEnabled();
  if (!enabled) {
    return result;
  }

  // Prevent concurrent syncs
  if (isSyncing) {
    return result;
  }

  // Check if any sync is needed
  const [garminNeeded, weatherNeeded] = await Promise.all([
    isGarminSyncNeeded().catch(() => false),
    shouldSyncWeather().catch(() => false),
  ]);

  if (!garminNeeded && !weatherNeeded) {
    return result;
  }

  isSyncing = true;
  await addLog('info', 'Auto-sync gestartet');

  try {
    // Sync Garmin if needed and connected
    if (garminNeeded) {
      const isConnected = await garminAuth.isSessionValid();
      if (isConnected) {
        try {
          const progress = await syncGarmin();
          result.garmin = progress.status === 'completed';
        } catch (error) {
          await addLog('error', `Auto-sync Garmin fehlgeschlagen: ${error}`);
        }
      }
    }

    // Sync Weather if needed
    if (weatherNeeded) {
      try {
        const weatherResult = await autoSyncWeather();
        result.weather = weatherResult !== null;
      } catch (error) {
        await addLog('error', `Auto-sync Wetter fehlgeschlagen: ${error}`);
      }
    }

    result.synced = result.garmin || result.weather;

    // Update last sync time
    if (result.synced) {
      await setSetting(LAST_AUTO_SYNC_KEY, new Date().toISOString());
      await addLog('info', `Auto-sync abgeschlossen: Garmin=${result.garmin}, Wetter=${result.weather}`);
    }
  } finally {
    isSyncing = false;
  }

  return result;
}

/**
 * Check if currently syncing
 */
export function isCurrentlySyncing(): boolean {
  return isSyncing;
}
```

Create src/lib/auto-sync/index.ts:
```typescript
export {
  isAutoSyncEnabled,
  setAutoSyncEnabled,
  getLastAutoSync,
  getAutoSyncStatus,
  performAutoSyncIfNeeded,
  isCurrentlySyncing,
  type AutoSyncStatus,
} from './service';
```
  </action>
  <verify>
1. tsc --noEmit shows no TypeScript errors
2. ls src/lib/auto-sync/ shows service.ts and index.ts
  </verify>
  <done>Auto-sync service created with performAutoSyncIfNeeded() function</done>
</task>

<task type="auto">
  <name>Task 2: Create AutoSyncSettings component and add to Settings</name>
  <files>src/features/sync/AutoSyncSettings.tsx, src/features/sync/index.ts, src/pages/Settings.tsx</files>
  <action>
1. Create src/features/sync/AutoSyncSettings.tsx:

```typescript
/**
 * Auto-Sync Settings Component
 */
import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { RefreshCw } from 'lucide-react';
import { toast } from 'sonner';
import {
  getAutoSyncStatus,
  setAutoSyncEnabled,
  performAutoSyncIfNeeded,
  type AutoSyncStatus,
} from '@/lib/auto-sync';

export function AutoSyncSettings() {
  const [status, setStatus] = useState<AutoSyncStatus>({
    enabled: true,
    lastSync: null,
    isSyncing: false,
  });
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    loadStatus();
  }, []);

  const loadStatus = async () => {
    try {
      const data = await getAutoSyncStatus();
      setStatus(data);
    } catch (error) {
      console.error('Failed to load auto-sync status:', error);
    }
  };

  const handleToggle = async (enabled: boolean) => {
    setLoading(true);
    try {
      await setAutoSyncEnabled(enabled);
      setStatus(prev => ({ ...prev, enabled }));
      toast.success(enabled ? 'Auto-Sync aktiviert' : 'Auto-Sync deaktiviert');
    } catch (error) {
      toast.error('Fehler beim Speichern');
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  const handleManualSync = async () => {
    setStatus(prev => ({ ...prev, isSyncing: true }));
    try {
      const result = await performAutoSyncIfNeeded();
      if (result.synced) {
        toast.success('Sync erfolgreich');
      } else {
        toast.info('Kein Sync nötig - Daten sind aktuell');
      }
      await loadStatus();
    } catch (error) {
      toast.error('Sync fehlgeschlagen');
      console.error(error);
    } finally {
      setStatus(prev => ({ ...prev, isSyncing: false }));
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <RefreshCw className="h-5 w-5" />
          Auto-Sync
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Enable/Disable Toggle */}
        <div className="flex items-center justify-between">
          <div className="space-y-0.5">
            <Label htmlFor="auto-sync-enabled">Beim App-Start synchronisieren</Label>
            <p className="text-sm text-slate-500">
              Synct automatisch wenn Daten älter als 24h sind
            </p>
          </div>
          <Switch
            id="auto-sync-enabled"
            checked={status.enabled}
            onCheckedChange={handleToggle}
            disabled={loading}
          />
        </div>

        {/* Status Info */}
        <div className="pt-2 border-t">
          <div className="text-sm flex justify-between">
            <span className="text-slate-500">Letzter Auto-Sync:</span>
            <span>
              {status.lastSync
                ? new Date(status.lastSync).toLocaleString('de-DE')
                : 'Noch nie'}
            </span>
          </div>
        </div>

        {/* Manual Sync Button */}
        <button
          onClick={handleManualSync}
          disabled={status.isSyncing}
          className="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md disabled:opacity-50"
        >
          <RefreshCw className={`h-4 w-4 ${status.isSyncing ? 'animate-spin' : ''}`} />
          {status.isSyncing ? 'Synchronisiere...' : 'Jetzt synchronisieren'}
        </button>
      </CardContent>
    </Card>
  );
}
```

2. Create src/features/sync/index.ts:
```typescript
export { AutoSyncSettings } from './AutoSyncSettings';
```

3. Update src/pages/Settings.tsx:
- Add import: `import { AutoSyncSettings } from '@/features/sync';`
- Add TabsTrigger after "Wetter": `<TabsTrigger value="sync">Sync</TabsTrigger>`
- Add TabsContent after weather tab:
```tsx
{/* Auto-Sync Tab */}
<TabsContent value="sync" className="space-y-4">
  <AutoSyncSettings />
</TabsContent>
```
  </action>
  <verify>
1. tsc --noEmit shows no TypeScript errors
2. grep "AutoSyncSettings" src/pages/Settings.tsx shows import and usage
3. npm run build succeeds
  </verify>
  <done>AutoSyncSettings component created and integrated into Settings page</done>
</task>

<task type="auto">
  <name>Task 3: Initialize auto-sync on app start</name>
  <files>src/App.tsx</files>
  <action>
Update src/App.tsx to trigger auto-sync on mount:

1. Add import at top:
```typescript
import { performAutoSyncIfNeeded } from '@/lib/auto-sync';
import { toast } from 'sonner';
```

2. Add useEffect inside the App component (after existing hooks, before return):
```typescript
// Auto-sync on app start
useEffect(() => {
  const runAutoSync = async () => {
    try {
      const result = await performAutoSyncIfNeeded();
      if (result.synced) {
        const parts = [];
        if (result.garmin) parts.push('Garmin');
        if (result.weather) parts.push('Wetter');
        toast.success(`Auto-Sync: ${parts.join(' & ')} aktualisiert`);
      }
    } catch (error) {
      console.error('Auto-sync failed:', error);
    }
  };

  // Small delay to let app render first
  const timer = setTimeout(runAutoSync, 1000);
  return () => clearTimeout(timer);
}, []);
```

Note: The 1 second delay ensures the app UI renders before sync starts, providing better UX.
  </action>
  <verify>
1. grep "performAutoSyncIfNeeded" src/App.tsx shows import and usage
2. npm run build succeeds
  </verify>
  <done>Auto-sync triggers on app start with toast notification on success</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] Auto-sync service files created in src/lib/auto-sync/
- [ ] AutoSyncSettings component created in src/features/sync/
- [ ] Settings page has new "Sync" tab
- [ ] App.tsx triggers auto-sync on mount
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Sync tab visible in Settings with toggle and status
- Auto-sync triggers on app open (with toast on success)
- Phase 7 complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-auto-sync/07-01-SUMMARY.md`
</output>
